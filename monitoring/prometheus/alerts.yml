# Prometheus Alert Rules
# Purpose: Defines alerting rules for Discord Music Bot monitoring
# Author: Discord Bot Team
# Last Updated: 2025-11-03
# Documentation: https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/

groups:
  # ============================================================================
  # Service Availability Alerts
  # ============================================================================
  - name: service_availability
    interval: 30s
    rules:
      - alert: ServiceDown
        expr: up{job=~"discord-(gateway|audio|api|worker)"} == 0
        for: 2m
        labels:
          severity: critical
          category: availability
        annotations:
          summary: "{{ $labels.job }} service is down"
          description: "Service {{ $labels.job }} on instance {{ $labels.instance }} has been down for more than 2 minutes."
          runbook: "https://docs.discord-bot.example.com/runbooks/service-down"

      - alert: HighPodRestartRate
        expr: rate(kube_pod_container_status_restarts_total{namespace="discord-bot"}[15m]) > 0.1
        for: 5m
        labels:
          severity: warning
          category: availability
        annotations:
          summary: "High pod restart rate for {{ $labels.pod }}"
          description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is restarting frequently ({{ $value }} restarts/sec)."
          runbook: "https://docs.discord-bot.example.com/runbooks/pod-restarts"

      - alert: PodCrashLooping
        expr: rate(kube_pod_container_status_restarts_total{namespace="discord-bot"}[30m]) > 0.5
        for: 10m
        labels:
          severity: critical
          category: availability
        annotations:
          summary: "Pod {{ $labels.pod }} is crash looping"
          description: "Pod {{ $labels.pod }} has restarted {{ $value }} times in the last 30 minutes."
          runbook: "https://docs.discord-bot.example.com/runbooks/crash-loop"

  # ============================================================================
  # Performance Alerts
  # ============================================================================
  - name: performance
    interval: 30s
    rules:
      - alert: HighLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job=~"discord-(gateway|audio|api)"}[5m])) > 1
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "High request latency on {{ $labels.job }}"
          description: "95th percentile latency is {{ $value }}s (threshold: 1s) for {{ $labels.job }}."
          runbook: "https://docs.discord-bot.example.com/runbooks/high-latency"

      - alert: VeryHighLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job=~"discord-(gateway|audio|api)"}[5m])) > 5
        for: 2m
        labels:
          severity: critical
          category: performance
        annotations:
          summary: "Very high request latency on {{ $labels.job }}"
          description: "95th percentile latency is {{ $value }}s (threshold: 5s) for {{ $labels.job }}. Users experiencing significant delays."
          runbook: "https://docs.discord-bot.example.com/runbooks/high-latency"

      - alert: HighErrorRate
        expr: (sum(rate(http_requests_total{job=~"discord-(gateway|audio|api)",status=~"5.."}[5m])) by (job) / sum(rate(http_requests_total{job=~"discord-(gateway|audio|api)"}[5m])) by (job)) > 0.05
        for: 5m
        labels:
          severity: critical
          category: performance
        annotations:
          summary: "High error rate on {{ $labels.job }}"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%) for {{ $labels.job }}."
          runbook: "https://docs.discord-bot.example.com/runbooks/high-error-rate"

      - alert: SlowDatabaseQueries
        expr: histogram_quantile(0.95, rate(database_query_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "Slow database queries detected"
          description: "95th percentile database query duration is {{ $value }}s (threshold: 2s). Check for missing indexes or lock contention."
          runbook: "https://docs.discord-bot.example.com/runbooks/slow-queries"

  # ============================================================================
  # Resource Alerts
  # ============================================================================
  - name: resources
    interval: 30s
    rules:
      - alert: HighCPUUsage
        expr: (sum(rate(container_cpu_usage_seconds_total{namespace="discord-bot",container!=""}[5m])) by (pod) / sum(container_spec_cpu_quota{namespace="discord-bot",container!=""}/container_spec_cpu_period{namespace="discord-bot",container!=""}) by (pod)) > 0.9
        for: 10m
        labels:
          severity: warning
          category: resources
        annotations:
          summary: "High CPU usage on {{ $labels.pod }}"
          description: "CPU usage is {{ $value | humanizePercentage }} (threshold: 90%) for pod {{ $labels.pod }}."
          runbook: "https://docs.discord-bot.example.com/runbooks/high-cpu"

      - alert: HighMemoryUsage
        expr: (sum(container_memory_working_set_bytes{namespace="discord-bot",container!=""}) by (pod) / sum(container_spec_memory_limit_bytes{namespace="discord-bot",container!=""}) by (pod)) > 0.9
        for: 10m
        labels:
          severity: warning
          category: resources
        annotations:
          summary: "High memory usage on {{ $labels.pod }}"
          description: "Memory usage is {{ $value | humanizePercentage }} (threshold: 90%) for pod {{ $labels.pod }}."
          runbook: "https://docs.discord-bot.example.com/runbooks/high-memory"

      - alert: PodOOMKilled
        expr: sum(kube_pod_container_status_terminated_reason{namespace="discord-bot",reason="OOMKilled"}) by (pod) > 0
        for: 1m
        labels:
          severity: critical
          category: resources
        annotations:
          summary: "Pod {{ $labels.pod }} was OOM killed"
          description: "Pod {{ $labels.pod }} was terminated due to out of memory. Increase memory limits."
          runbook: "https://docs.discord-bot.example.com/runbooks/oom-killed"

      - alert: DiskSpaceWarning
        expr: (1 - (node_filesystem_avail_bytes{mountpoint=~"/data|/var/lib/postgresql/data"} / node_filesystem_size_bytes{mountpoint=~"/data|/var/lib/postgresql/data"})) > 0.8
        for: 5m
        labels:
          severity: warning
          category: resources
        annotations:
          summary: "Disk space running low on {{ $labels.instance }}"
          description: "Disk usage is {{ $value | humanizePercentage }} (threshold: 80%) on {{ $labels.mountpoint }}."
          runbook: "https://docs.discord-bot.example.com/runbooks/disk-space"

      - alert: DiskSpaceCritical
        expr: (1 - (node_filesystem_avail_bytes{mountpoint=~"/data|/var/lib/postgresql/data"} / node_filesystem_size_bytes{mountpoint=~"/data|/var/lib/postgresql/data"})) > 0.95
        for: 2m
        labels:
          severity: critical
          category: resources
        annotations:
          summary: "Disk space critically low on {{ $labels.instance }}"
          description: "Disk usage is {{ $value | humanizePercentage }} (threshold: 95%) on {{ $labels.mountpoint }}. Immediate action required."
          runbook: "https://docs.discord-bot.example.com/runbooks/disk-space"

  # ============================================================================
  # Database Alerts
  # ============================================================================
  - name: database
    interval: 30s
    rules:
      - alert: PostgreSQLDown
        expr: pg_up == 0
        for: 2m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "PostgreSQL is down"
          description: "PostgreSQL database on {{ $labels.instance }} has been down for more than 2 minutes."
          runbook: "https://docs.discord-bot.example.com/runbooks/postgres-down"

      - alert: PostgreSQLTooManyConnections
        expr: sum(pg_stat_activity_count) > (pg_settings_max_connections * 0.8)
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "PostgreSQL connection pool nearly exhausted"
          description: "PostgreSQL has {{ $value }} connections (threshold: 80% of max_connections)."
          runbook: "https://docs.discord-bot.example.com/runbooks/postgres-connections"

      - alert: PostgreSQLDeadlocks
        expr: rate(pg_stat_database_deadlocks[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "PostgreSQL deadlocks detected"
          description: "Deadlock rate is {{ $value }}/sec. Review query patterns and add proper locking."
          runbook: "https://docs.discord-bot.example.com/runbooks/postgres-deadlocks"

      - alert: PostgreSQLReplicationLag
        expr: pg_replication_lag > 60
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "PostgreSQL replication lag detected"
          description: "Replication lag is {{ $value }}s (threshold: 60s) on {{ $labels.instance }}."
          runbook: "https://docs.discord-bot.example.com/runbooks/postgres-replication"

  # ============================================================================
  # Redis Alerts
  # ============================================================================
  - name: redis
    interval: 30s
    rules:
      - alert: RedisDown
        expr: redis_up == 0
        for: 2m
        labels:
          severity: critical
          category: redis
        annotations:
          summary: "Redis is down"
          description: "Redis instance on {{ $labels.instance }} has been down for more than 2 minutes."
          runbook: "https://docs.discord-bot.example.com/runbooks/redis-down"

      - alert: RedisHighMemoryUsage
        expr: (redis_memory_used_bytes / redis_memory_max_bytes) > 0.9
        for: 5m
        labels:
          severity: warning
          category: redis
        annotations:
          summary: "Redis memory usage high"
          description: "Redis memory usage is {{ $value | humanizePercentage }} (threshold: 90%) on {{ $labels.instance }}."
          runbook: "https://docs.discord-bot.example.com/runbooks/redis-memory"

      - alert: RedisEvictionRate
        expr: rate(redis_evicted_keys_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          category: redis
        annotations:
          summary: "High Redis key eviction rate"
          description: "Redis is evicting {{ $value }} keys/sec. Consider increasing maxmemory or reviewing cache TTLs."
          runbook: "https://docs.discord-bot.example.com/runbooks/redis-eviction"

      - alert: RedisRejectedConnections
        expr: rate(redis_rejected_connections_total[5m]) > 0
        for: 2m
        labels:
          severity: critical
          category: redis
        annotations:
          summary: "Redis rejecting connections"
          description: "Redis is rejecting connections at {{ $value }}/sec. Max clients limit reached."
          runbook: "https://docs.discord-bot.example.com/runbooks/redis-connections"

  # ============================================================================
  # Application-Specific Alerts
  # ============================================================================
  - name: discord_bot
    interval: 30s
    rules:
      - alert: DiscordAPIErrors
        expr: rate(discord_api_errors_total[5m]) > 1
        for: 5m
        labels:
          severity: warning
          category: application
        annotations:
          summary: "High Discord API error rate"
          description: "Discord API error rate is {{ $value }}/sec for {{ $labels.operation }}."
          runbook: "https://docs.discord-bot.example.com/runbooks/discord-api-errors"

      - alert: LavalinkDisconnected
        expr: lavalink_connected == 0
        for: 2m
        labels:
          severity: critical
          category: application
        annotations:
          summary: "Lavalink disconnected"
          description: "Lavalink node {{ $labels.node }} is disconnected. Music playback will fail."
          runbook: "https://docs.discord-bot.example.com/runbooks/lavalink-down"

      - alert: HighMusicQueueDepth
        expr: avg(music_queue_depth) by (guild_id) > 100
        for: 10m
        labels:
          severity: info
          category: application
        annotations:
          summary: "Very long music queue"
          description: "Guild {{ $labels.guild_id }} has {{ $value }} tracks in queue."
          runbook: "https://docs.discord-bot.example.com/runbooks/long-queue"

      - alert: FailedPaymentWebhooks
        expr: rate(stripe_webhook_errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: critical
          category: application
        annotations:
          summary: "Stripe webhook failures detected"
          description: "Stripe webhook error rate is {{ $value }}/sec. Subscriptions may not activate."
          runbook: "https://docs.discord-bot.example.com/runbooks/stripe-webhooks"

      - alert: SubscriptionActivationFailures
        expr: rate(subscription_activation_failures_total[5m]) > 0.1
        for: 5m
        labels:
          severity: critical
          category: application
        annotations:
          summary: "Subscription activation failures"
          description: "Subscription activation failure rate is {{ $value }}/sec. Users paying but not getting premium."
          runbook: "https://docs.discord-bot.example.com/runbooks/subscription-activation"

  # ============================================================================
  # Auto-Scaling Alerts
  # ============================================================================
  - name: autoscaling
    interval: 30s
    rules:
      - alert: HPAMaxedOut
        expr: kube_hpa_status_current_replicas{namespace="discord-bot"} >= kube_hpa_spec_max_replicas{namespace="discord-bot"}
        for: 15m
        labels:
          severity: warning
          category: autoscaling
        annotations:
          summary: "HPA {{ $labels.hpa }} at maximum replicas"
          description: "HPA {{ $labels.hpa }} has been at max replicas ({{ $value }}) for 15 minutes. Consider increasing max replicas."
          runbook: "https://docs.discord-bot.example.com/runbooks/hpa-maxed"

      - alert: HPAScalingFailure
        expr: rate(kube_hpa_status_condition{status="false",condition="ScalingActive"}[5m]) > 0
        for: 5m
        labels:
          severity: warning
          category: autoscaling
        annotations:
          summary: "HPA {{ $labels.hpa }} scaling failure"
          description: "HPA {{ $labels.hpa }} is unable to scale. Check metrics server and resource limits."
          runbook: "https://docs.discord-bot.example.com/runbooks/hpa-failure"

  # ============================================================================
  # Security Alerts
  # ============================================================================
  - name: security
    interval: 30s
    rules:
      - alert: UnauthorizedAPIAccess
        expr: rate(http_requests_total{status="401"}[5m]) > 5
        for: 5m
        labels:
          severity: warning
          category: security
        annotations:
          summary: "High rate of unauthorized API access"
          description: "{{ $value }} unauthorized requests/sec to {{ $labels.endpoint }}. Potential attack."
          runbook: "https://docs.discord-bot.example.com/runbooks/unauthorized-access"

      - alert: RateLimitExceeded
        expr: rate(http_requests_total{status="429"}[5m]) > 10
        for: 5m
        labels:
          severity: info
          category: security
        annotations:
          summary: "High rate limit exceeded count"
          description: "{{ $value }} rate-limited requests/sec. May indicate abuse or insufficient limits."
          runbook: "https://docs.discord-bot.example.com/runbooks/rate-limit"

      - alert: SuspiciousNetworkActivity
        expr: rate(network_policy_violations_total[5m]) > 1
        for: 5m
        labels:
          severity: critical
          category: security
        annotations:
          summary: "Network policy violations detected"
          description: "{{ $value }} network policy violations/sec. Potential security breach."
          runbook: "https://docs.discord-bot.example.com/runbooks/network-violations"
