name: Security Monitoring

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual runs

jobs:
  dependency-review:
    runs-on: ubuntu-latest
    name: Dependency Review & Vulnerability Monitoring
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run comprehensive npm audit
        run: pnpm audit --audit-level moderate
        continue-on-error: true
      
      - name: Generate audit report
        run: |
          echo "# Security Audit Report - $(date)" > audit-report.md
          echo "" >> audit-report.md
          echo "## npm audit results:" >> audit-report.md
          pnpm audit --json > audit.json || true
          if [ -s audit.json ]; then
            echo "Found vulnerabilities in dependencies" >> audit-report.md
          else
            echo "No vulnerabilities found" >> audit-report.md
          fi
      
      - name: Run Snyk comprehensive scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --all-projects --json
        continue-on-error: true
      
      - name: Check for outdated packages
        run: |
          echo "" >> audit-report.md
          echo "## Outdated packages:" >> audit-report.md
          pnpm outdated || echo "All packages are up to date" >> audit-report.md
      
      - name: Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report-${{ github.run_number }}
          path: |
            audit-report.md
            audit.json
            snyk.json
          retention-days: 30

  codeql:
    runs-on: ubuntu-latest
    name: CodeQL Analysis
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: github/codeql-action/init@v3
        with:
          languages: javascript
          queries: security-extended
      
      - uses: github/codeql-action/autobuild@v3
      
      - uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"