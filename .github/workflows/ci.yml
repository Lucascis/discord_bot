name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Cancel in-progress runs on same branch
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '22'
  PNPM_VERSION: '10.16.1'

jobs:
  # Quality checks (lint + typecheck) in parallel
  quality:
    name: ðŸ“ Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm --filter @discord-bot/database prisma:generate

      - name: Build all packages
        run: pnpm build

      - name: TypeScript Type Checking
        run: pnpm typecheck

      - name: ESLint
        run: |
          pnpm lint --format stylish || {
            echo "::error::ESLint found issues"
            echo "## âŒ ESLint Issues Found" >> $GITHUB_STEP_SUMMARY
            exit 1
          }

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            **/dist/
            !**/node_modules/
          retention-days: 1

  # Test suite with services
  test:
    name: ðŸ§ª Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [quality]

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: discord_bot_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm --filter @discord-bot/database prisma:generate

      - name: Build packages
        run: pnpm build

      - name: Validate test environment
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/discord_bot_test
          REDIS_URL: redis://localhost:6379
        run: |
          echo "Validating test environment setup..."

          # Install PostgreSQL client tools
          sudo apt-get update -qq
          sudo apt-get install -y -qq postgresql-client > /dev/null

          # Validate PostgreSQL connection
          echo "Testing PostgreSQL connection..."
          if ! timeout 10 bash -c 'until pg_isready -h localhost -p 5432 -U postgres; do sleep 1; done'; then
            echo "::error::Cannot connect to PostgreSQL!"
            exit 1
          fi

          # Validate Redis connection (using netcat as it's pre-installed)
          echo "Testing Redis connection..."
          if ! timeout 10 bash -c 'until nc -z localhost 6379; do sleep 1; done'; then
            echo "::error::Cannot connect to Redis!"
            exit 1
          fi

          echo "âœ… Environment validation passed" >> $GITHUB_STEP_SUMMARY

      - name: Setup test database
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/discord_bot_test
          REDIS_URL: redis://localhost:6379
        run: |
          echo "Deploying database migrations..."
          if ! pnpm --filter @discord-bot/database prisma:deploy; then
            echo "::error::Database migration failed!"
            echo "## âŒ Database Migration Failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "Seeding test database..."
          if ! pnpm db:seed; then
            echo "::warning::Database seeding failed (non-critical)"
            echo "âš ï¸ Seeding failed but continuing..." >> $GITHUB_STEP_SUMMARY
          fi

          echo "âœ… Database setup completed" >> $GITHUB_STEP_SUMMARY

      - name: Run tests with coverage
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/discord_bot_test
          REDIS_URL: redis://localhost:6379
          NODE_ENV: test
          DISCORD_TOKEN: test_token_for_ci_pipeline
          DISCORD_APPLICATION_ID: '123456789012345678'
          LAVALINK_HOST: localhost
          LAVALINK_PORT: '2333'
          LAVALINK_PASSWORD: youshallnotpass
        run: pnpm test:coverage

      - name: Generate coverage summary
        if: always()
        run: |
          echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ ! -f coverage/coverage-summary.json ]; then
            echo "âš ï¸ No coverage data available (tests may have been skipped)" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "Tests completed for commit ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸ“Š Test Coverage" >> $GITHUB_STEP_SUMMARY
          LINES_PCT=$(jq -r '.total.lines.pct' coverage/coverage-summary.json 2>/dev/null)
          STATEMENTS_PCT=$(jq -r '.total.statements.pct' coverage/coverage-summary.json 2>/dev/null)
          FUNCTIONS_PCT=$(jq -r '.total.functions.pct' coverage/coverage-summary.json 2>/dev/null)
          BRANCHES_PCT=$(jq -r '.total.branches.pct' coverage/coverage-summary.json 2>/dev/null)

          # Validate parsed values
          [ -z "$LINES_PCT" ] || [ "$LINES_PCT" = "null" ] && LINES_PCT="N/A"
          [ -z "$STATEMENTS_PCT" ] || [ "$STATEMENTS_PCT" = "null" ] && STATEMENTS_PCT="N/A"
          [ -z "$FUNCTIONS_PCT" ] || [ "$FUNCTIONS_PCT" = "null" ] && FUNCTIONS_PCT="N/A"
          [ -z "$BRANCHES_PCT" ] || [ "$BRANCHES_PCT" = "null" ] && BRANCHES_PCT="N/A"

          echo "| Metric | Coverage |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lines | ${LINES_PCT}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Statements | ${STATEMENTS_PCT}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Functions | ${FUNCTIONS_PCT}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Branches | ${BRANCHES_PCT}% |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check coverage threshold (80%) using awk instead of bc
          if [ "$LINES_PCT" != "N/A" ]; then
            if awk -v coverage="$LINES_PCT" 'BEGIN { exit !(coverage < 80) }'; then
              echo "âš ï¸ Coverage below 80% threshold (${LINES_PCT}%)" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… Coverage meets threshold (${LINES_PCT}%)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always() && hashFiles('coverage/lcov.info') != ''
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  # Docker build verification
  docker-build:
    name: ðŸ³ Docker Build
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [quality]
    strategy:
      fail-fast: false
      matrix:
        service: [gateway, audio, api, worker]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.service }} service
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          target: ${{ matrix.service }}
          tags: discord-bot-${{ matrix.service }}:test
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}
          load: true

      - name: Verify container image configuration
        run: |
          echo "ðŸ” Inspecting docker image configuration..."

          # Extract image metadata
          CMD=$(docker image inspect discord-bot-${{ matrix.service }}:test --format='{{json .Config.Cmd}}')
          ENTRYPOINT=$(docker image inspect discord-bot-${{ matrix.service }}:test --format='{{json .Config.Entrypoint}}')
          USER=$(docker image inspect discord-bot-${{ matrix.service }}:test --format='{{.Config.User}}')
          WORKDIR=$(docker image inspect discord-bot-${{ matrix.service }}:test --format='{{.Config.WorkingDir}}')

          # Generate summary
          echo "## ðŸ³ Docker Image: ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CMD:** \`$CMD\`" >> $GITHUB_STEP_SUMMARY
          echo "**Entrypoint:** \`$ENTRYPOINT\`" >> $GITHUB_STEP_SUMMARY
          echo "**User:** \`$USER\`" >> $GITHUB_STEP_SUMMARY
          echo "**WorkDir:** \`$WORKDIR\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verify CMD is set
          if [ "$CMD" = "null" ] && [ "$ENTRYPOINT" = "null" ]; then
            echo "::error::No CMD or ENTRYPOINT defined!"
            echo "âŒ **Error:** No CMD/ENTRYPOINT" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Verify image size
          SIZE=$(docker image inspect discord-bot-${{ matrix.service }}:test --format='{{.Size}}')
          SIZE_MB=$((SIZE / 1024 / 1024))
          echo "**Image Size:** ${SIZE_MB}MB" >> $GITHUB_STEP_SUMMARY

          if [ $SIZE_MB -gt 2000 ]; then
            echo "::warning::Image size is large (${SIZE_MB}MB > 2000MB)"
            echo "âš ï¸ **Warning:** Large image size" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Image size acceptable" >> $GITHUB_STEP_SUMMARY
          fi

          # Count layers (excluding header line)
          LAYER_COUNT=$(docker history discord-bot-${{ matrix.service }}:test --no-trunc --format "{{.ID}}" | wc -l)
          echo "**Layers:** $LAYER_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Scan for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: discord-bot-${{ matrix.service }}:test
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Generate security summary
        if: always()
        run: |
          echo "## ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "Scanned for CRITICAL and HIGH severity vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "See workflow logs for detailed Trivy report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  # Final validation
  ci-success:
    name: âœ… CI Pipeline Success
    runs-on: ubuntu-latest
    needs: [quality, test, docker-build]
    if: always()
    steps:
      - name: Check all jobs succeeded
        run: |
          if [ "${{ needs.quality.result }}" != "success" ]; then
            echo "âŒ Quality checks failed"
            exit 1
          fi
          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "âŒ Tests failed"
            exit 1
          fi
          if [ "${{ needs.docker-build.result }}" != "success" ]; then
            echo "âŒ Docker build failed"
            exit 1
          fi

          echo "## âœ… CI Pipeline Success!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All checks passed for commit ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code quality checks passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… All tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Docker builds successful" >> $GITHUB_STEP_SUMMARY
